name: DebugBuild

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-latest

    steps:
      # --- リポ + サブモジュール ---
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          submodules: recursive

      - name: Ensure submodules present
        shell: pwsh
        run: |
          git submodule sync --recursive
          git submodule update --init --recursive

      # --- MSBuild を PATH に ---
      - name: Setup MSBuild
        uses: microsoft/setup-msbuild@v2

      # --- ルート確認（デバッグ用）---
      - name: Echo workspace and tree (top)
        shell: pwsh
        run: |
          Write-Host "GITHUB_WORKSPACE = $env:GITHUB_WORKSPACE"
          Get-ChildItem -Path $env:GITHUB_WORKSPACE -Depth 2 | Select-Object FullName

      # --- DirectXTex の場所を動的に検出 → Debug x64 でビルド ---
      - name: Locate and build DirectXTex (Debug x64)
        shell: pwsh
        run: |
          # DirectXTex のディレクトリを検索（サブモジュール/externals/ どこでもOK）
          $dxtexDir = Get-ChildItem -Path $env:GITHUB_WORKSPACE -Recurse -Directory -Filter DirectXTex `
            | Where-Object { Test-Path (Join-Path $_.FullName 'DirectXTex_Desktop_2022_Win10.vcxproj') } `
            | Select-Object -First 1

          if (-not $dxtexDir) {
            Write-Host "Found candidate 'DirectXTex' folders (for debug):"
            Get-ChildItem -Path $env:GITHUB_WORKSPACE -Recurse -Directory -Filter DirectXTex | ForEach-Object { $_.FullName }
            throw "DirectXTex_Desktop_2022_Win10.vcxproj が見つかりません。パスを確認してください。"
          }

          Write-Host "DirectXTex dir = $($dxtexDir.FullName)"
          Push-Location $dxtexDir.FullName
          msbuild DirectXTex_Desktop_2022_Win10.vcxproj /p:Platform=x64 /p:Configuration=Debug /m
          Pop-Location

      # --- Debug lib を Development エイリアスへ複製（Debug を利用）---
      - name: Make Development alias for DirectXTex (use Debug lib)
        shell: pwsh
        run: |
          $binRoot = Join-Path $env:GITHUB_WORKSPACE 'CG\externals\DirectXTex\Bin'
          if (-not (Test-Path $binRoot)) {
            # サブモジュールの場所が異なる場合に備え、ビルド結果から再探索
            $dxBin = Get-ChildItem -Path $env:GITHUB_WORKSPACE -Recurse -Directory -Filter Bin `
              | Where-Object { $_.FullName -match 'DirectXTex\\Bin$' } | Select-Object -First 1
            if ($dxBin) { $binRoot = $dxBin.FullName }
          }
          if (-not (Test-Path $binRoot)) { throw "DirectXTex\\Bin が見つかりません: $binRoot" }

          $lib = Get-ChildItem -Path $binRoot -Recurse -Filter DirectXTex.lib |
                 Where-Object { $_.FullName -match '\\x64\\' -and $_.FullName -match '\\Debug\\' } |
                 Select-Object -First 1

          if ($null -eq $lib) {
            Write-Host "Found libs (for debug):"
            Get-ChildItem -Path $binRoot -Recurse -Filter DirectXTex.lib | ForEach-Object { $_.FullName }
            throw "DirectXTex.lib (x64/Debug) が見つかりません: $binRoot"
          }

          $devDir = Split-Path $lib.DirectoryName -Parent | Join-Path -ChildPath 'Development'
          New-Item -ItemType Directory -Force -Path $devDir | Out-Null
          Copy-Item -Force $lib.FullName (Join-Path $devDir 'DirectXTex.lib')
          Write-Host "Copied DirectXTex.lib -> $devDir"

      # --- ソリューションの場所を動的に検出 → Debug x64 でビルド ---
      - name: Locate solution and build (Debug x64)
        shell: pwsh
        run: |
          $sln = Get-ChildItem -Path $env:GITHUB_WORKSPACE -Recurse -Filter 'DirectXGame.sln' | Select-Object -First 1
          if (-not $sln) {
            throw "DirectXGame.sln がリポジトリ内に見つかりません。パスを確認してください。"
          }
          Write-Host "Solution = $($sln.FullName)"
          Push-Location $sln.DirectoryName
          msbuild "DirectXGame.sln" /p:Platform=x64 /p:Configuration=Debug /m
          Pop-Location
